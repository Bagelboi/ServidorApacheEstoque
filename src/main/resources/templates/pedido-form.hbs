<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create/Edit Pedido</title>
    <style>
        table { border-collapse: collapse; width: 50%; margin-bottom: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        button { margin-top: 5px; }
    </style>
</head>
<body>
    <h1>{{#if pedido}}Edit{{else}}Create{{/if}} Pedido</h1>
    <form id="pedidoForm" method="POST" action="{{#if pedido}}/pedido/update{{else}}/pedido/create{{/if}}">
        <label for="id">ID:</label>
        <input type="number" id="id" name="id" value="{{pedido.id}}" {{#if pedido}}readonly{{/if}} required>
        <br><br>

        <label for="data">Data:</label>
        <input type="date" id="data" name="data" value="{{pedido.data}}" required>
        <br><br>

        <label for="cliente">Cliente:</label>
        <input type="text" id="cliente" name="cliente" value="{{pedido.cliente}}" required>
        <br><br>

        <label for="transporte">Transporte:</label>
        <input type="text" id="transporte" name="transporte" value="{{pedido.transporte}}">
        <br><br>

        <label for="pagamento">Pagamento:</label>
        <input type="text" id="pagamento" name="pagamento" value="{{pedido.pagamento}}">
        <br><br>

        <label for="nota_fiscal">Nota Fiscal:</label>
        <input type="number" id="nota_fiscal" name="nota_fiscal" value="{{pedido.nota_fiscal}}">
        <br><br>

        <label for="coleta">Coleta:</label>
        <input type="number" id="coleta" name="coleta" value="{{pedido.coleta}}">
        <br><br>

                <label for="valor">Valor:</label>
                <h3>R$</h3><input type="number" id="valor" name="valor" value="{{pedido.valor}}">
                <br><br>


        <label for="OC">OC:</label>
        <input type="number" id="OC" name="OC" value="{{pedido.OC}}">
        <br><br>

        <h3>Produtos</h3>
        <table id="produtosTable">
            <thead>
                <tr>
                    <th>SKU</th>
                    <th>Quantia</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {{#each pedido.produtos}}
                <tr>
                    <td><input type="text" name="produtos[{{@key}}][sku]" value="{{@key}}" required></td>
                    <td><input type="number" min="0" name="produtos[{{@key}}][quantia]" value="{{this}}" required></td>
                    <td><button type="button" class="removeRow">Remove</button></td>
                </tr>
                {{/each}}
            </tbody>
        </table>
        <button type="button" id="addProduto">Add Produto</button>
        <br><br>

        <button type="submit">Save Pedido</button>
    </form>

    <script>
    const tableBody = document.querySelector("#produtosTable tbody");
    const addBtn = document.getElementById("addProduto");

    let newIndex = 0;

    function attachEstoqueListener(row) {
        const skuInput = row.querySelector('input[name*="[sku]"]');
        const quantiaInput = row.querySelector('input[name*="[quantia]"]');

        skuInput.addEventListener("change", async () => {
            const sku = skuInput.value.trim();
            if (!sku) return;

            try {
                const response = await fetch(`/produto/estoque/${sku}`);
                if (!response.ok) throw new Error("Not found");
                const data = await response.json();

                quantiaInput.max = data.estoque;
                quantiaInput.placeholder = `Máx: ${data.estoque}`;
                quantiaInput.title = `Estoque disponível: ${data.estoque}`;
            } catch (err) {
                quantiaInput.max = "";
                quantiaInput.placeholder = "SKU inválido";
                quantiaInput.title = "SKU não encontrado";
            }
        });
    }

    // attach to existing rows (edit mode)
    document.querySelectorAll("#produtosTable tbody tr").forEach(row => attachEstoqueListener(row));

    addBtn.addEventListener("click", () => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td><input type="text" name="produtos[new_${newIndex}][sku]" required></td>
            <td><input type="number" min="0" name="produtos[new_${newIndex}][quantia]" required></td>
            <td><button type="button" class="removeRow">Remove</button></td>
        `;
        newIndex++;
        tableBody.appendChild(row);
        attachEstoqueListener(row);
    });

    tableBody.addEventListener("click", (e) => {
        if (e.target.classList.contains("removeRow")) {
            e.target.closest("tr").remove();
        }
    });
    </script>

</body>
</html>
